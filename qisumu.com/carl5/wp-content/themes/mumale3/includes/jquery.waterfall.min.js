/**
 * @name jQuery waterfall Plugin
 * @version 1.0.6
 * @create 2012.1.30
 * @lastmodified 2012.2.11
 * @description Based on jQuery 1.4+
 * @author MuFeng (http://mufeng.me)
 * @url http://mufeng.me/waterfall.html
 **/
~
function(h) {
	var j = [],
	f = 0,
	g = function(b, a) {
		this.options = b;
		this.element = h(a);
		this.init()
	};
	g.prototype = {
		init: function() {
			this.initArg();
			this.reSize();
			this.layout(this.getBricks(this.element))
		},
		getBricks: function(a) {
			var b = this.options.itemSelector;
			return $bricks = !b ? a.children().not(".waterfall") : a.filter(b).not(".waterfall").add(a.find(b))
		},
		getSize: function() {
			var c = this.getBricks(this.element)[0],
			e = h(c),
			b = this.options.columnCount,
			r = this.options.columnWidth,
			d = [],
			n = e.outerWidth(true),
			q = h(window).width() - 20,
			a = !r ? n: r,
			p = !b ? parseInt(q / a) : b;
			return d.concat(a, p)
		},
		initArg: function() {
			if (!f) {
				var a, b = this.getSize(),
				c = b[1];
				for (a = 0; a < c; a++) {
					j[a] = 0
				}
				f = 1
			}
		},
		reSize: function() {
			if (this.options.isResizable) {
				var b = this.getSize(),
				c = b[1],
				a = b[0];
				this.element.css({
					width: c * a
				})
			}
		},
		layout: function(c) {
			var A = 0,
			d = this.element,
			E = c.length,
			e = d.filter("img").add(d.find("img")).eq(0),
			H = e.parent(),
			C = this.options.isAnimated,
			n = this.options.Duration,
			D = this.options.Easing,
			w = this.options.endFn,
			t = this.getSize(),
			a = t[0],
			F,
			I = H.width() - parseInt(e.css("padding-left")) - parseInt(e.css("padding-right")) - parseInt(e.css("margin-left")) - parseInt(e.css("margin-right"));
			c.css("display", "none");
			var B = (function() {
				var l = [],
				o = null,
				k = function() {
					var p = 0;
					for (; p < l.length; p++) {
						l[p].end ? l.splice(p--, 1) : l[p]()
					} ! l.length && m()
				},
				m = function() {
					clearTimeout(o);
					o = null
				};
				return function(q, v, u, x) {
					var z, p, s, L, r, M = new Image();
					M.src = q;
					if (M.complete) {
						v(M.width, M.height);
						u && u(M.width, M.height);
						return
					}
					p = M.width;
					s = M.height;
					z = function() {
						L = M.width;
						r = M.height;
						if (L !== p || r !== s || L * r > 1024) {
							v(L, r);
							z.end = true
						}
					};
					z();
					M.onerror = function() {
						x && x();
						L = r = 0;
						v(L, r);
						z.end = true;
						M = M.onload = M.onerror = null
					};
					M.onload = function() {
						u && u(M.width, M.height); ! z.end && z();
						M = M.onload = M.onerror = null
					};
					if (!z.end) {
						l.push(z);
						if (o === null) {
							o = setTimeout(k, 50)
						}
					}
				}
			})();
			G();
			function G() {
				if (A < E) {
					var k = c[A],
					s = h(k),
					l = s.filter("img").add(s.find("img")).eq(0),
					q = s.outerHeight(true),
					m = b(j);
					if (l.length > 0) {
						var r = l.attr("src");
						l.removeAttr("src");
						l.removeAttr("width");
						l.removeAttr("height");
						B(r,
						function(z, u) {
							z = z ? z: I;
							u = u ? u: 0;
							y = u * I / z;
							z = I;
							l.attr("src", r).css({
								width: z,
								height: u,
								display: "block"
							});
							var v = Math.max.apply(Math, j);
							d.height(v);
							s.addClass("waterfall");
							var x = s.outerHeight(true); ! C ? (s.css({
								display: "block",
								position: "absolute",
								left: m * a,
								top: j[m]
							})) : (s.css({
								display: "block",
								position: "absolute",
								left: 0,
								top: v
							}).stop().animate({
								left: m * a,
								top: j[m]
							},
							{
								Duration: n,
								Easing: D
							}));
							j[m] += x;
							A++;
							F = setTimeout(G, 50)
						})
					} else {
						var o = Math.max.apply(Math, j);
						d.height(o);
						s.addClass("waterfall");
						var p = s.outerHeight(true); ! C ? (s.css({
							display: "block",
							position: "absolute",
							left: m * a,
							top: j[m]
						})) : (s.css({
							display: "block",
							position: "absolute",
							left: 0,
							top: o
						}).stop().animate({
							left: m * a,
							top: j[m]
						},
						{
							Duration: n,
							Easing: D
						}));
						j[m] += p;
						A++;
						F = setTimeout(G, 10)
					}
				} else {
					if (A >= E) {
						clearTimeout(F);
						F = null;
						var o = Math.max.apply(Math, j);
						d.height(o);
						if (typeof w == "function") {
							w.call(c)
						}
					}
				}
			}
			function b(k) {
				var p, l = 0,
				m = k[0],
				o = k.length;
				for (p = 1; p < o; p++) {
					if (k[p] < m) {
						m = k[p];
						l = p
					}
				}
				return l
			}
		}
	};
	h.waterfall = function(b, a) {
		b = h.extend({
			isResizable: false,
			isAnimated: false,
			Duration: 500,
			Easing: "swing",
			endFn: function() {}
		},
		b);
		h.data(a, "waterfall", new g(b, a));
		return a
	};
	h.fn.waterfall = function(a) {
		return h.waterfall(a, this)
	};
	function i(a) {
		console.log({}.toString.call(a) + " | " + a)
	}
} (jQuery);